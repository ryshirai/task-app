# 本番デプロイ計画（シンプル版 / 個人開発・推奨）

このドキュメントは **個人製作のアプリ向け** に、低コストかつ運用負荷を最小化する本番デプロイ計画をまとめたものです。  
既存の `docs/production_deployment_roadmap.md` は **大規模・企業向け** として維持し、本書はその軽量版として位置づけます。

## 0. 方針（個人開発向け）
- まずは「無料枠 + 従量課金の最小構成」で開始する
- 高可用性や高度な監視より、運用の単純さを優先する
- 1人で回せる手順（障害調査、再デプロイ、バックアップ）に限定する

## 1. 構成案A（PaaS活用 / 最優先）

### 1.1 推奨構成
- Frontend: `Vercel`
- Backend: `Render` または `Fly.io`
- DB: `Supabase` または `Neon`（PostgreSQL、無料枠活用）

### 1.2 この案を優先する理由
- 初期構築が最短（GitHub 連携中心）
- HTTPS が標準提供される
- 小規模トラフィックなら無料枠/低額で運用しやすい
- インフラ管理（VPC/NAT/WAF など）の負担を大幅に削減できる

### 1.3 注意点
- 無料枠はスリープ/コールドスタートがある場合がある
- ベンダーごとの制約（リージョン、接続数、ビルド時間）を確認する
- サービス横断で障害要因が分散するため、ログ確認先を固定する

## 2. 構成案B（AWS最小構成）

### 2.1 構成
- Frontend: `AWS Amplify`
- Backend: `AWS App Runner`
- DB: `Amazon RDS for PostgreSQL (db.t4g.micro)`

### 2.2 この案が向くケース
- 将来的に AWS へ寄せたい
- IAM や CloudWatch を使った運用に慣れておきたい
- 単一クラウドでまとめたい

### 2.3 コスト観点
- 構成案Aより固定費が増えやすい（特に RDS）
- 低トラフィック期は停止/スケジュール運用などで抑制を検討する

## 3. 共通（GitHub Actions 自動デプロイ）

### 3.1 最小パイプライン
1. `push`（`main`）で起動
2. Backend テスト（例: `cargo test`）+ Frontend ビルド（例: `npm run build`）
3. 各ホスティングへデプロイ
4. デプロイ後にヘルスチェック（`/health`）を実行

### 3.2 実運用ルール（最小）
- `main` への直接 push は避け、PR マージ経由にする
- 失敗時は前バージョンへ戻す手順（再デプロイ）を 1 つ決める
- Secrets は GitHub Actions Secrets / 各PaaSの環境変数に限定する

## 4. セキュリティ（最小限）

### 4.1 HTTPS
- Vercel / Render / Fly.io / Amplify / App Runner の標準 HTTPS を利用
- 独自ドメイン設定後、HTTP から HTTPS へのリダイレクトを有効化

### 4.2 環境変数管理（最小）
- 必須のみ管理（例: `DATABASE_URL`, `JWT_SECRET`, `PUBLIC_API_BASE_URL`）
- 開発/本番で値を分離し、`.env` をリポジトリにコミットしない
- 使わなくなった変数は定期的に削除する

## 5. メンテナンス（少ない手間で回す）

### 5.1 ログ確認方法
- Frontend: Vercel または Amplify のデプロイログ/実行ログを確認
- Backend: Render/Fly.io または App Runner のアプリログを確認
- DB: Supabase/Neon/RDS の接続エラー・遅いクエリログを週1で確認

### 5.2 簡単なDBバックアップ
- Supabase/Neon: 提供機能（バックアップ/ブランチ/リストア）を利用
- RDS: 自動バックアップを有効化し、保持期間を設定
- 重要データは月1回 `pg_dump` を取得して別ストレージへ保管

## 6. どちらを選ぶか（結論）
- **第一選択**: 構成案A（PaaS活用）  
  理由: 最小コスト、最小運用、最速リリースのバランスが良い
- **第二選択**: 構成案B（AWS最小構成）  
  理由: AWS統一運用を見据える場合に有効

## 7. 導入ステップ（1週間目安）
1. 構成案A/B を選択（迷ったらA）
2. GitHub と各サービスを接続して初回デプロイ
3. 独自ドメイン + HTTPS を有効化
4. GitHub Actions の `main` 自動デプロイを有効化
5. ログ確認手順とバックアップ手順を `docs` に1ページで固定

